<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, user-scalable=no"
      name="viewport"
    />
    <title>Spacescape</title>
    <style>
      body{
        img.responsive {
            max-width: 100%; 
            max-height: 300px; 
            display: block; 
            margin: auto; 
        }
      }
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: "Orbitron", sans-serif;
        background-color: #1a1a2e;
        
        color: #ffffff;
        overflow: hidden;
      }
      .screen {
        display: none;
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
        
      }
      .screen.active {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        
      }
      canvas {
        display: block;
      }
      .container {
        text-align: center;
        max-width: 600px;
        width: 90%;
      }
      button {
        background: linear-gradient(135deg, #283c86 0%, #45a247 100%);
        border: 2px solid #fff;
        border-radius: 8px;
        color: #fff;
        font-family: "Orbitron", sans-serif;
        font-size: 18px;
        text-transform: uppercase;
        text-align: center;
        text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        padding: 12px 30px;
        margin: 20px auto 0;
        display: block;
        width: 215.15px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      button:hover {
        background: linear-gradient(135deg, #45a247 0%, #283c86 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      #game-title {
        font-size: 2.5em;
        margin-bottom: 30px;
        text-transform: uppercase;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        color: #e94560;
      }
      #game-controls {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: rgba(26, 26, 46, 0.8);
        padding: 10px 0;
        z-index: 101;
        display: none;
        text-align: center;
      }
      #game-controls button {
        display: inline-block;
        width: auto;
        padding: 8px 15px;
        margin: 0 5px;
        font-size: 14px;
      }
      #hud {
        position: fixed;
        top: 50px;
        left: 0;
        width: 100%;
        color: white;
        padding: 10px;
        z-index: 100;
        display: none;
        font-family: "Orbitron", sans-serif;
      }
      #timer,
      #coinCounter,
      #fireRateDisplay {
        font-size: 20px;
        margin: 5px 10px;
      }
      #game-container {
        position: relative;
        width: 100%;
        height: calc(100% - 100px);
        overflow: hidden;
        background-color: #0f3460;
        border: 2px solid #e94560;
        box-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
      }
      #instructions-screen.overlay {
        background: rgba(0, 0, 0, 0.8);
      }
      #instructions-screen .container {
        background: #1a1a2e;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
      }
      @media (max-width: 600px) {
        #game-title {
          font-size: 2em;
        }
        button {
          width: 80%;
          font-size: 16px;
        }
        #game-controls button {
          font-size: 12px;
          padding: 6px 12px;
        }
      }
    </style>
  </head>
  <body>
    <img src="loadingscreenimageSpaceEscape.png" 
        alt="Responsive Image"
        class="responsive">
    <div id="game-controls">
      <button id="game-menu-button">Menu</button>
      <button id="game-restart-button">Restart</button>
      <button id="game-instructions-button">Instructions</button>
    </div>

    <div id="hud">
      <div id="timer">Time: 0</div>
      <div id="coinCounter">Coins: 0</div>
      <div id="fireRateDisplay">Fire Rate: 2.00</div>
    </div>

    <div id="start-menu-screen" class="active screen">
      <div class="container">
        <h1 id="game-title">Spacescape</h1>
        <button id="play-button">Play</button>
        <button id="settings-button">Settings</button>
        <button id="instructions-button">Instructions</button>
      </div>
    </div>

    <div id="settings-screen" class="screen">
      <div class="container">
        <h2>There are no settings at the moment</h2>
        <button id="settings-back-button">Back</button>
      </div>
    </div>

    <div id="instructions-screen" class="screen">
      <div class="container">
        <h2>Instructions</h2>
        <h3>How to Play:</h3>
        <ul>
          <li>Move with WASD keys</li>
          <li>Aim and shoot with mouse</li>
          <li>Press 1 to upgrade fire rate (costs 5 coins)</li>
          <li>Press 2 to place tower (costs 10 coins)</li>
          <li>Collect coins from defeated enemies</li>
        </ul>
        <button id="instructions-back-button">Back</button>
      </div>
    </div>

    <div id="game-screen" class="screen">
      <div id="game-container">
        <canvas id="gameCanvas"></canvas>
      </div>
    </div>

    <div id="game-over-screen" class="screen">
      <div class="container">
        
        <h2>Game Over</h2>
        <div id="game-over-message"></div>
        <button id="play-again-button">Play Again</button>
        <button id="main-menu-button">Main Menu</button>
      
      </div>
    </div>
    
    <!-- ALL AUDIO HTML -->
     <!-- game music -->
    <audio id="lobby-music" loop>
      <source src="Cosmic Shadows.mp3" type="audio/mpeg" />
    </audio>
    <audio id="background-music" loop>
      <source src="background-music.mp3" type="audio/mpeg" />
    </audio>
    <audio id="gameover-music">
      <source src="GameOverSound2.wav"  type="audio/wav"> 
    </audio>

    <!-- NEED TO GENERATE THESE SOUNDS -->
    <!-- turret -->
    <audio id="turret-place-sound" src="turret_place.mp3"></audio>
    <audio id="turret-death-sound" src="turret_death.mp3"></audio>
    <audio id="turret-shoot-sound" src="turret_shoot.mp3"></audio>
    <!-- ship -->
    <audio id="ship-move-sound" src="ship_move.mp3" loop></audio>
    <audio id="ship-shoot-sound" src="ship_shoot.mp3"></audio>
    <audio id="ship-destroy-sound" src="ship_destroy.mp3"></audio>
    <audio id="attack-upgrade-sound" src="attack_upgrade.mp3"></audio>
    <!-- enemy -->
    <audio id="enemy-death-sound" src="enemy_death.mp3"></audio>
    

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        class GameUI {
          constructor() {
            this.startMenuScreen = document.getElementById("start-menu-screen");
            this.settingsScreen = document.getElementById("settings-screen");
            this.instructionsScreen = document.getElementById(
              "instructions-screen",
            );
            this.gameScreen = document.getElementById("game-screen");
            this.gameOverScreen = document.getElementById("game-over-screen");
            this.gameControls = document.getElementById("game-controls");
            this.hud = document.getElementById("hud");

            // Game UI elements
            this.canvas = document.getElementById("gameCanvas");
            this.ctx = this.canvas.getContext("2d");
            this.timerElement = document.getElementById("timer");
            this.coinCounterElement = document.getElementById("coinCounter");
            this.fireRateDisplayElement =
              document.getElementById("fireRateDisplay");
            
            //Load sound effects
            this.sounds = {
              //turret sounds
              turretPlacement: document.getElementById("turret-place-sound"),
              turretDeath: document.getElementById("turret-death-sound"),
              turretShoot: document.getElementById("turret-shoot-sound"),
              //ship sounds
              shipMove: document.getElementById("ship-move-sound"),
              shipShoot: document.getElementById("ship-shoot-sound"),
              shipDestroy: document.getElementById("ship-destroy-sound"),
              attackUpgrade: document.getElementById("attack-upgrade-sound"),
              //enemy sounds
              enemyDeath: document.getElementById("enemy-death-sound"),
            };
          }

          swapToScreen(screen) {
            this.startMenuScreen.classList.remove("active");
            this.settingsScreen.classList.remove("active");
            this.instructionsScreen.classList.remove("active");
            this.gameScreen.classList.remove("active");
            this.gameOverScreen.classList.remove("active");
            screen.classList.add("active");

            if (screen.id === "game-screen") {
              this.hud.style.display = "block";
              this.gameControls.style.display = "block";
              this.resizeCanvas();
            } else {
              this.hud.style.display = "none";
              this.gameControls.style.display = "none";
            }
          }

          resizeCanvas() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
          }

          startGame() {
            const backgroundMusic = document.getElementById("background-music");
            backgroundMusic.play().catch((error) => {
              console.error(
                "Error attempting to play background music:",
                error,
              );
            });
            this.swapToScreen(this.gameScreen);
          }

          endGame(backgroundMusic) {
            backgroundMusic.pause();  // Stop the background music
            backgroundMusic.currentTime = 0;  // Reset it to the beginning
            
            const gameOverMusic = document.getElementById('gameover-music');
            gameOverMusic.play().catch((error) => {
              console.error(
                "Error attempting to play game over music:",
                error,
              );
            });
            
            this.swapToScreen(this.gameOverScreen);
          }

          mainMenu() {
            this.swapToScreen(this.startMenuScreen);
          }

          settings() {
            this.swapToScreen(this.settingsScreen);
          }

          instructions() {
            this.swapToScreen(this.instructionsScreen);
          }

          updateHUD(time, coins, fireRate) {
            this.timerElement.textContent = `Time: ${time.toFixed(1)}`;
            this.coinCounterElement.textContent = `Coins: ${coins}`;
            this.fireRateDisplayElement.textContent = `Fire Rate: ${fireRate.toFixed(2)}`;
          }
        }

        class GameLogic {
          constructor(ui) {
            this.ui = ui;
            this.ctx = ui.ctx;

            // Game state
            this.gameOver = false;
            this.startTime = null;
            this.elapsedTime = 0;
            this.lastFrameTime = 0;
            this.coinCount = 0;
            this.fireRate = 2;

            // Game objects
            this.player = {
              x: window.innerWidth / 2,
              y: window.innerHeight / 2,
              size: 60,
              speed: 5,
            };
            this.projectiles = [];
            this.enemies = [];
            this.coins = [];
            this.towers = [];

            // Game settings
            this.projectileSpeed = 8;
            this.enemySize = 30;
            this.enemySpeed = 2;
            this.spawnRate = 1;
            this.coinSize = 20;
            this.towerSize = 50;
            this.towerRange = 100;
            this.towerFireRate = 2;

            // Control states
            this.isShooting = false;
            this.keys = { w: false, a: false, s: false, d: false };
            this.mouseX = 0;
            this.mouseY = 0;

            this.touchX = 0;
            this.touchY = 0;
            this.isTouching = false;
            this.isMoving = false;
            this.moveSoundPlaying = false;

            // Timing
            this.timeSinceLastSpawn = 0;
            this.timeSinceLastShot = 0;
            this.fps = 60;
            this.frameInterval = 1000 / this.fps;

            // Load images
            this.images = {
              player: new Image(),
              enemy: new Image(),
              coin: new Image(),
              background: new Image(),
              tower: new Image(),
            };

            this.images.player.src = "player.png";
            this.images.enemy.src = "enemy.png";
            this.images.coin.src = "coin.png";
            this.images.background.src = "background.png";
            this.images.tower.src = "tower.png";

            this.setupEventListeners();
          }

          setupEventListeners() {
            window.addEventListener("mousemove", (e) => {
              this.mouseX = e.clientX;
              this.mouseY = e.clientY;
            });

            window.addEventListener("mousedown", (e) => {
              if (e.button === 0) this.isShooting = true;
            });

            window.addEventListener("mouseup", (e) => {
              if (e.button === 0) this.isShooting = false;
            });

            window.addEventListener("keydown", (e) => {
              if (e.key === "w") this.keys.w = true;
              if (e.key === "a") this.keys.a = true;
              if (e.key === "s") this.keys.s = true;
              if (e.key === "d") this.keys.d = true;

              if (e.key === "1") this.upgradeFireRate();
              if (e.key === "2") this.placeTower();
            });

            window.addEventListener("keyup", (e) => {
              if (e.key === "w") this.keys.w = false;
              if (e.key === "a") this.keys.a = false;
              if (e.key === "s") this.keys.s = false;
              if (e.key === "d") this.keys.d = false;
            });

            window.addEventListener(
              "touchstart",
              (e) => {
                e.preventDefault();
                this.isTouching = true;
                this.isShooting = true;
                const touch = e.touches[0];
                this.touchX = touch.clientX;
                this.touchY = touch.clientY;
                this.mouseX = touch.clientX; // Update mouse position for aiming
                this.mouseY = touch.clientY;
              },
              { passive: false },
            );

            window.addEventListener(
              "touchmove",
              (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                this.touchX = touch.clientX;
                this.touchY = touch.clientY;
                this.mouseX = touch.clientX; // Update mouse position for aiming
                this.mouseY = touch.clientY;
              },
              { passive: false },
            );

            window.addEventListener(
              "touchend",
              (e) => {
                e.preventDefault();
                this.isTouching = false;
                this.isShooting = false;
              },
              { passive: false },
            );
          }

          reset() {
            this.gameOver = false;
            this.player.x = window.innerWidth / 2;
            this.player.y = window.innerHeight / 2;
            this.enemies.length = 0;
            this.projectiles.length = 0;
            this.coins.length = 0;
            this.towers.length = 0;
            this.coinCount = 0;
            this.fireRate = 2;
            this.startTime = null;
            this.elapsedTime = 0;
            this.timeSinceLastSpawn = 0;
            this.timeSinceLastShot = 0;
          }

          movePlayer() {
            this.isMoving = false
            if (this.keys.w && this.player.y > 0) {
              this.player.y -= this.player.speed;
              this.isMoving = true;
            }
            if (this.keys.a && this.player.x > 0) {
              this.player.x -= this.player.speed;
              this.isMoving = true;
            }
            if (this.keys.s && this.player.y < this.ui.canvas.height){
              this.player.y += this.player.speed;
              this.isMoving = true;
            }
            if (this.keys.d && this.player.x < this.ui.canvas.width) {
              this.player.x += this.player.speed;
              this.isMoving = true;
            }
            // **Ship Moving Sound**
            if (this.isMoving && !this.moveSoundPlaying) {
              this.ui.sounds.shipMove.play().catch((error) => {
                console.error("Error playing ship movement sound:", error);
              });
              this.moveSoundPlaying = true;
            } else if (!this.isMoving) {
              this.ui.sounds.shipMove.pause();
              this.ui.sounds.shipMove.currentTime = 0;
              this.moveSoundPlaying = false;
            }
          }

          shootProjectile() {
            const angle = Math.atan2(
              this.mouseY - this.player.y,
              this.mouseX - this.player.x,
            );
            const vx = Math.cos(angle) * this.projectileSpeed;
            const vy = Math.sin(angle) * this.projectileSpeed;
            this.projectiles.push({
              x: this.player.x,
              y: this.player.y,
              size: 5,
              vx,
              vy,
            });

            // **Ship Shooting Sound**
            this.ui.sounds.shipShoot.play().catch((error) => {
              console.error("Error playing ship shooting sound:", error);
            });
          }

          spawnEnemy() {
            const side = Math.floor(Math.random() * 4);
            let x, y;
            switch (side) {
              case 0: // Top
                x = Math.random() * this.ui.canvas.width;
                y = -this.enemySize;
                break;
              case 1: // Right
                x = this.ui.canvas.width + this.enemySize;
                y = Math.random() * this.ui.canvas.height;
                break;
              case 2: // Bottom
                x = Math.random() * this.ui.canvas.width;
                y = this.ui.canvas.height + this.enemySize;
                break;
              case 3: // Left
                x = -this.enemySize;
                y = Math.random() * this.ui.canvas.height;
                break;
            }
            this.enemies.push({ x, y });
          }

          dropCoin(x, y) {
            this.coins.push({ x, y });
          }

          upgradeFireRate() {
            if (this.coinCount >= 5) {
              this.coinCount -= 5;
              this.fireRate *= 1.1;

               // **Attack Speed Upgrade Sound**
              this.ui.sounds.attackUpgrade.play().catch((error) => {
                console.error("Error playing attack upgrade sound:", error);
              });
            }
          }

          placeTower() {
            if (this.coinCount >= 10) {
              this.coinCount -= 10;
              this.towers.push({
                x: this.player.x,
                y: this.player.y,
                timeSinceLastShot: 0,
                //added health, where each health is equal to 1 green lv. 1 enemy
                health: 5
              });
              // **Turret Placement Sound**
              this.ui.sounds.turretPlacement.play().catch((error) => {
                console.error("Error playing turret placement sound:", error);
              });
            }
          }

          update(timestamp) {
            if (this.gameOver) return;

            if (!this.startTime) this.startTime = timestamp;
            this.elapsedTime = (timestamp - this.startTime) / 1000;

            this.movePlayer();

            // Spawn enemies
            this.timeSinceLastSpawn += this.frameInterval / 1000;
            if (this.timeSinceLastSpawn >= 1 / this.spawnRate) {
              this.spawnEnemy();
              this.timeSinceLastSpawn = 0;
            }

            // Shooting logic
            this.timeSinceLastShot += this.frameInterval / 1000;
            if (
              this.timeSinceLastShot >= 1 / this.fireRate &&
              this.isShooting
            ) {
              this.shootProjectile();
              this.timeSinceLastShot = 0;
            }

            this.ui.updateHUD(this.elapsedTime, this.coinCount, this.fireRate);
          }

          draw() {
            const backgroundMusic = document.getElementById("background-music");

            const ctx = this.ui.ctx;
            ctx.clearRect(0, 0, this.ui.canvas.width, this.ui.canvas.height);

            // Draw background
            ctx.drawImage(
              this.images.background,
              0,
              0,
              this.ui.canvas.width,
              this.ui.canvas.height,
            );

            // Draw player
            const angle = Math.atan2(
              this.mouseY - this.player.y,
              this.mouseX - this.player.x,
            );
            ctx.save();
            ctx.translate(this.player.x, this.player.y);
            ctx.rotate(angle);
            ctx.drawImage(
              this.images.player,
              -this.player.size / 2,
              -this.player.size / 2,
              this.player.size,
              this.player.size,
            );
            ctx.restore();

            // Draw projectiles
            ctx.fillStyle = "yellow";
            this.projectiles.forEach((proj, index) => {
              proj.x += proj.vx;
              proj.y += proj.vy;
              ctx.fillRect(
                proj.x - proj.size / 2,
                proj.y - proj.size / 2,
                proj.size,
                proj.size,
              );

              if (
                proj.x < 0 ||
                proj.x > this.ui.canvas.width ||
                proj.y < 0 ||
                proj.y > this.ui.canvas.height
              ) {
                this.projectiles.splice(index, 1);
              }
            });

            // Draw and update enemies
            this.enemies.forEach((enemy, index) => {
              //see if player or turret closer, default player
              let target = this.player
              let closestDist = Math.hypot(enemy.x - this.player.x, enemy.y - this.player.y);
      
              // Find nearest tower
              if (this.towers.length > 0){
                this.towers.forEach(tower => {
                  let towerDist = Math.hypot(enemy.x - tower.x, enemy.y - tower.y);
                  if (towerDist < closestDist) {
                    target = tower;
                    closestDist = towerDist;
                  }
                });
              }
              
              const angle = Math.atan2(
                target.y - enemy.y,
                target.x - enemy.x,
              );
              console.log(angle)
              enemy.x += Math.cos(angle) * this.enemySpeed;
              enemy.y += Math.sin(angle) * this.enemySpeed;
              
              
              ctx.drawImage(
                this.images.enemy,
                enemy.x - this.enemySize / 2,
                enemy.y - this.enemySize / 2,
                this.enemySize,
                this.enemySize,
              );

              // Check collisions player
              const dist = Math.hypot(
                this.player.x - enemy.x,
                this.player.y - enemy.y,
              );
              if (dist < this.player.size / 2 + this.enemySize / 2) {
                this.gameOver = true;
                this.ui.endGame(backgroundMusic);

                // **Ship Destruction Sound**
                this.ui.sounds.shipDestroy.play().catch((error) => {
                  console.error("Error playing ship destruction sound:", error);
                });
              }
               // Check collision with towers
              if (this.towers.length > 0){
                this.towers.forEach((tower, tIndex) => {
                  const towerdist = Math.hypot(enemy.x - tower.x, enemy.y - tower.y);
                  if ( towerdist < this.towerSize / 2 + this.enemySize / 2) {
                    tower.health -= 1; // Damage tower
                    if (tower.health <= 0) {
                      this.towers.splice(tIndex, 1); // Remove destroyed tower
                       // **Turret Death Sound**
                      this.ui.sounds.turretDeath.play().catch((error) => {
                        console.error("Error playing turret death sound:", error);
                      });
                    }
                    this.enemies.splice(index, 1); // Remove enemy after attack
                  }
                });
              }


              this.projectiles.forEach((proj, projIndex) => {
                const projDist = Math.hypot(proj.x - enemy.x, proj.y - enemy.y);
                if (projDist < proj.size / 2 + this.enemySize / 2) {
                  this.enemies.splice(index, 1);
                  this.projectiles.splice(projIndex, 1);
                  
                  // **Enemy Death Sound**
                  this.ui.sounds.enemyDeath.play().catch((error) => {
                    console.error("Error playing enemy death sound:", error);
                  });

                  this.dropCoin(enemy.x, enemy.y);
                }
              });
            });

            // Draw coins
            this.coins.forEach((coin, index) => {
              ctx.drawImage(
                this.images.coin,
                coin.x - this.coinSize / 2,
                coin.y - this.coinSize / 2,
                this.coinSize,
                this.coinSize,
              );

              const dist = Math.hypot(
                this.player.x - coin.x,
                this.player.y - coin.y,
              );
              if (dist < this.player.size / 2 + this.coinSize / 2) {
                this.coins.splice(index, 1);
                this.coinCount++;
              }
            });

            // Draw towers
            this.towers.forEach((tower) => {
             
              ctx.drawImage(
                this.images.tower,
                tower.x - this.towerSize / 2,
                tower.y - this.towerSize / 2,
                this.towerSize,
                this.towerSize,
              );
              ctx.fillStyle = "red";
              ctx.fillRect(tower.x - 25, tower.y - 35, 50 * (tower.health / 5), 5); // Health bar
              ctx.fillStyle = "white";
              ctx.font = "14px Arial";
              ctx.fillText(`HP: ${tower.health}`, tower.x - 15, tower.y - 40);

              let nearestEnemy = null;
              let nearestDistance = this.towerRange;
              this.enemies.forEach((enemy) => {
                const dist = Math.hypot(tower.x - enemy.x, tower.y - enemy.y);
                if (dist < nearestDistance) {
                  nearestEnemy = enemy;
                  nearestDistance = dist;
                }
              });

              if (nearestEnemy) {
                tower.timeSinceLastShot += this.frameInterval / 1000;
                if (tower.timeSinceLastShot >= 1 / this.towerFireRate) {
                  const angle = Math.atan2(
                    nearestEnemy.y - tower.y,
                    nearestEnemy.x - tower.x,
                  );
                  const vx = Math.cos(angle) * this.projectileSpeed;
                  const vy = Math.sin(angle) * this.projectileSpeed;
                  this.projectiles.push({
                    x: tower.x,
                    y: tower.y,
                    size: 5,
                    vx,
                    vy,
                  });
                  // **Turret Shooting Sound**
                  this.ui.sounds.turretShoot.play().catch((error) => {
                    console.error("Error playing turret shooting sound:", error);
                  });
                  tower.timeSinceLastShot = 0;
                }
              }
            });
          }
        }

        class Game {
          constructor() {
            this.ui = new GameUI();
            this.logic = new GameLogic(this.ui);
            this.animationFrameId = null;
            this.isPaused = false;
          }

          prepareGame() {
            window.addEventListener("resize", () => this.ui.resizeCanvas());
            this.ui.resizeCanvas();
            this.assignButtons();
          }

          startGame() {
            this.logic.reset();
            this.ui.startGame();
            if (this.animationFrameId) {
              cancelAnimationFrame(this.animationFrameId);
            }
            this.gameLoop(0);
          }

          gameLoop(timestamp) {
            if (this.logic.gameOver) {
              return
            };
            
            const deltaTime = timestamp - this.logic.lastFrameTime;
            if (deltaTime > this.logic.frameInterval) {
              this.logic.update(timestamp);
              this.logic.draw();
              this.logic.lastFrameTime = timestamp;
            }

            if (this.animationFrameId) {
              cancelAnimationFrame(this.animationFrameId);
            }
            this.animationFrameId = requestAnimationFrame(
              this.gameLoop.bind(this),
            );
          }

          pause() {
            this.isPaused = true;
            cancelAnimationFrame(this.animationFrameId);
          }

          resume() {
            this.isPaused = false;
            this.gameLoop(0);
          }

          assignButtons() {
            const addButtonListener = (id, callback) => {
              const button = document.getElementById(id);
              if (button) {
                button.addEventListener("click", callback);
                button.addEventListener(
                  "touchstart",
                  (e) => {
                    e.preventDefault();
                    callback();
                  },
                  { passive: false },
                );
              }
            };

            addButtonListener("play-button", () => this.startGame());
            addButtonListener("settings-button", () => this.ui.settings());
            addButtonListener("instructions-button", () =>
              this.ui.instructions(),
            );
            addButtonListener("play-again-button", () => this.startGame());
            addButtonListener("settings-back-button", () => this.ui.mainMenu());
            addButtonListener("instructions-back-button", () =>
              this.ui.mainMenu(),
            );
            addButtonListener("main-menu-button", () => this.ui.mainMenu());
            addButtonListener("game-menu-button", () => this.ui.mainMenu());
            addButtonListener("game-restart-button", () => this.startGame());
            addButtonListener("game-instructions-button", () => {
              this.pause();
              this.ui.instructions();
              const backButton = document.getElementById(
                "instructions-back-button",
              );
              const handler = () => {
                this.ui.swapToScreen(this.ui.gameScreen);
                this.resume();
                backButton.removeEventListener("click", handler);
                backButton.removeEventListener("touchstart", handler);
              };
              backButton.addEventListener("click", handler);
              backButton.addEventListener(
                "touchstart",
                (e) => {
                  e.preventDefault();
                  handler();
                },
                { passive: false },
              );
            });
          }
        }

        const game = new Game();
        game.prepareGame();
      });
    </script>
  </body>
</html>
